<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link href="./styles.css" rel="stylesheet">
    <title>DSC Editor</title>
    <meta name="theme-color" content="#9a8cee" />
  </head>
  <body>
    <div id="progresswnd" class="progresswnd translucent">
      <div id="progressflex" class="progresswnd progresswndinner">
        <div id="progresscontainer" class="modalwnd" style="height: 80px; cursor: progress !important;">
          <div id="progressheader" class="modalwndheader" style="cursor: progress !important;">Loading...</div>
          <div id="progressinside" class="modalwndinside" style="cursor: progress !important;"><progress id="progressbar" style="height: revert; width: 100%; margin: auto; accent-color: #8074c9; cursor: progress !important;" max="1"></progress></div>
        </div>
      </div>
    </div>
    <div id="modalbg" class="modalbg translucent invisible hidden">
      <div id="modalwnd" class="modalwnd">
        <div id="modalwndheader" class="modalwndheader"></div>
        <div id="modalwndinside" class="modalwndinside" style="min-height: 50px;"></div>
        <div id="modalwndfooter" class="modalwndfooter"></div>
      </div>
    </div>
    <div class="gradient2">
      <div class="menubar" id="menubar">
        <div class="menubaritem" id="menubaritem_file"><div class=menubaritemtext>File</div></div>
        <div class="menubaritem" id="menubaritem_edit"><div class=menubaritemtext>Edit</div></div>
        <div class="menubaritem" id="menubaritem_tools"><div class=menubaritemtext>Tools</div></div>
        <div class="menubaritem" id="menubaritem_convert"><div class=menubaritemtext>Convert</div></div>
        <div class="menubaritem" id="menubaritem_bookmarks"><div class=menubaritemtext>Bookmarks</div></div>
        <div class="menubaritem" id="menubaritem_help"><div class=menubaritemtext>Help</div></div>
      </div>
      <div class="toolbar" id="toolbar">
        <div class="toolbutton hastooltip" id="toolopen"><span class="menu gradient tooltip">Open...</span><img class="toolicon" src="./icons/OpenFile.svg" draggable="false"/></div>
        <div class="toolbutton hastooltip toolbutton-disabled" id="toolsave"><span class="menu gradient tooltip">Save</span><img class="toolicon" src="./icons/Save.svg" draggable="false"/></div>
        <div class="toolbutton hastooltip" id="toolsaveas"><span class="menu gradient tooltip">Save as...</span><img class="toolicon" src="./icons/SaveAs.svg" draggable="false"/></div>
        <div class="toolseparator"></div>
        <div class="toolbutton hastooltip toolbutton-disabled" id="toolundo"><span class="menu gradient tooltip">Undo</span><img class="toolicon" src="./icons/Undo.svg" draggable="false"/></div>
        <div class="toolbutton hastooltip toolbutton-disabled" id="toolredo"><span class="menu gradient tooltip">Redo</span><img class="toolicon" src="./icons/Redo.svg" draggable="false"/></div>
        <div class="toolseparator"></div>
        <div class="toolbutton hastooltip" id="toolsearch"><span class="menu gradient tooltip">Find...</span><img class="toolicon" src="./icons/Search.svg" draggable="false"/></div>
        <div class="toolseparator"></div>
        <div class="toolbutton hastooltip" id="toolbktoggle"><span class="menu gradient tooltip">Toggle bookmark</span><img class="toolicon" src="./icons/Bookmark.svg" draggable="false"/></div>
        <div class="toolbutton hastooltip toolbutton-disabled" id="toolbkprev"><span class="menu gradient tooltip">Previous bookmark</span><img class="toolicon" src="./icons/PreviousBookmark.svg" draggable="false"/></div>
        <div class="toolbutton hastooltip toolbutton-disabled" id="toolbknext"><span class="menu gradient tooltip">Next bookmark</span><img class="toolicon" src="./icons/NextBookmark.svg" draggable="false"/></div>
        <div class="toolbutton hastooltip toolbutton-disabled" id="toolbkclear"><span class="menu gradient tooltip">Remove all bookmarks</span><img class="toolicon" src="./icons/ClearBookmark.svg" draggable="false"/></div>
      </div>
    </div>
    <div id="container" class="editor"></div>

    <div id="footer" class="footer gradient2">
      <label for="format">Game:</label><select name="Format" id="dscfmt" autocomplete="off" style="margin-left: 5px;">
        <option value="ft">FT</option>
        <option value="dt2">DT 2nd</option>
      </select>

      <label for="dscver" style="margin-left: 10px;">Format: 0x</label><input type="text" id="dscver" name="dscver" pattern="[a-fA-F\d]+" minlength="8" maxlength="8" autocomplete="off">
    </div>

    <div class="menu gradient2" id="menu_file" hidden>
      <div class="menuitem" id="menuitem_open"><img src="./icons/OpenFile.svg" class="menuicon-small"><div class="menuitemtext">Open...</div></div>
      <div class="menuitem menuitem-disabled" id="menuitem_save"><img src="./icons/Save.svg" class="menuicon-small"><div class="menuitemtext">Save</div></div>
      <div class="menuitem" id="menuitem_saveas"><img src="./icons/SaveAs.svg" class="menuicon-small"><div class="menuitemtext">Save as...</div></div>
    </div>
    <div class="menu gradient2" id="menu_edit" hidden>
      <div class="menuitem menuitem-disabled" id="menuitem_undo"><img src="./icons/Undo.svg" class="menuicon-small"><div class="menuitemtext">Undo</div></div>
      <div class="menuitem menuitem-disabled" id="menuitem_redo"><img src="./icons/Redo.svg" class="menuicon-small"><div class="menuitemtext">Redo</div></div>
      <div class="menuitem" id="menuitem_find"><img src="./icons/Search.svg" class="menuicon-small"><div class="menuitemtext">Find...</div></div>
      <div class="menuitem" id="menuitem_replace"><div class="menuicon-small"></div><div class="menuitemtext">Replace...</div></div>
    </div>
    <div class="menu gradient2" id="menu_tools" hidden>
      <div class="menuitem" id="menuitem_rmtargets"><div class="menuitemtext">Remove TARGET, BAR_TIME_SET, and TARGET_FLYING_TIME</div></div>
      <div class="menuitem" id="menuitem_timecleanup"><div class="menuitemtext">Remove unused TIME commands</div></div>
      <div class="menuitem" id="menuitem_rmcommands"><div class="menuitemtext">Remove or isolate commands...</div></div>
    </div>
    <div class="menu gradient2" id="menu_convert" hidden>
      <!--<div class="menuitem" id="menuitem_convert_f_ft"><div class="menuitemtext">DT 2nd/f to FT...</div></div>-->
      <div class="menuitem" id="menuitem_convert_d2_ft"><div class="menuitemtext">Coming soonâ„¢</div><img src="./icons/pokeslow-a.png" class="menuicon"></div>
    </div>
    <div class="menu gradient2" id="menu_bookmarks" hidden>
      <div class="menuitem" id="menuitem_togglebkm"><img src="./icons/Bookmark.svg" class="menuicon-small"><div class="menuitemtext">Toggle bookmark</div></div>
      <div class="menuitem menuitem-disabled" id="menuitem_prevbkm"><img src="./icons/PreviousBookmark.svg" class="menuicon-small"><div class="menuitemtext">Previous bookmark</div></div>
      <div class="menuitem menuitem-disabled" id="menuitem_nextbkm"><img src="./icons/NextBookmark.svg" class="menuicon-small"><div class="menuitemtext">Next bookmark</div></div>
      <div class="menuitem menuitem-disabled" id="menuitem_rmallbkm"><img src="./icons/ClearBookmark.svg" class="menuicon-small"><div class="menuitemtext">Remove all bookmarks</div></div>
    </div>
    <div class="menu gradient2" id="menu_help" hidden>
      <div class="menuitem" id="menuitem_about"><div class="menuitemtext">About...</div></div>
      <div class="menuitem" id="menuitem_src"><div class="menuitemtext">Source code...</div></div>
    </div>
  </body>
  <script src="./node_modules/monaco-editor/min/vs/loader.js"></script>
	<script>
    var editor;
    var bookmarks = [];
    var fileHandle;
    var modified = false;

    var fileApi = 'showSaveFilePicker' in window;
    var browser_dark = window.matchMedia('(prefers-color-scheme: dark)').matches;

    function setDarkMode(value) {
      browser_dark = value;
      monaco.editor.setTheme(browser_dark ? 'vs-dark' : 'vs-light');
    }

    window.matchMedia("(prefers-color-scheme: dark)").addListener(
      e => e.matches && setDarkMode(true)
    );

    window.matchMedia("(prefers-color-scheme: light)").addListener(
      e => e.matches && setDarkMode(false)
    );

    if (fileApi)
    {
      document.getElementById('toolsave').classList.remove('toolbutton-disabled');
      document.getElementById('menuitem_save').classList.remove('menuitem-disabled');
    }
    else
    {
      document.getElementById('menuitem_save').childNodes[1].innerText = 'Save (requires Chrome)';
    }

    function setProgress(progress, caption)
    {
      const wnd = document.getElementById("progresswnd");
      if (progress == -1)
      {
        wnd.setAttribute('hidden', 'true');
      }
      else
      {
        if (typeof caption !== 'undefined')
        {
          document.getElementById("progressheader").innerText = caption;
        }
        document.getElementById("progressbar").value = progress;
        wnd.removeAttribute('hidden');
      }
    }

    function dialogEx(caption, content, fnok)
    {
      const bg = document.getElementById('modalbg');
      const container = document.getElementById('modalwndinside');
      const header = document.getElementById('modalwndheader');
      const footer = document.getElementById('modalwndfooter');
      footer.classList.add('gradient');
      header.innerText = caption;
      container.innerText = content;
      
      const btnok = document.createElement('btn');
      btnok.classList.add('modalbtn');
      btnok.classList.add('modalbtn_blue');
      btnok.innerText = fnok ? 'Yes' : 'OK';
      function closewnd()
      {
          bg.classList.add('invisible');
          setTimeout(function() { 
              bg.classList.add('hidden');
              header.innerHTML = '';
              container.innerHTML = '';
              footer.innerHTML = '';
          }, 300);
      }
      btnok.onclick = function()
      {
          closewnd();
          if (fnok)
          {
            fnok();
          }
      }
      footer.appendChild(btnok);

      if (fnok)
      {
        const btnno = document.createElement('btn');
        btnno.classList.add('modalbtn');
        btnno.classList.add('modalbtn_red');
        btnno.innerText = 'No';
        btnno.onclick = function()
        {
            closewnd();
        }
        footer.appendChild(btnno);
      }

      bg.classList.remove('hidden');
      bg.clientWidth;
      bg.classList.remove('invisible');
    }

    function setModified(_modified)
    {
      if (modified != _modified)
      {
        modified = _modified;
        const hasModifiedStr = document.title.startsWith('* ');
        if (modified && !hasModifiedStr)
        {
          document.title = '* ' + document.title;
        }
        else if (!modified && hasModifiedStr)
        {
          document.title = document.title.substring(2);
        }
      }
    }

    document.getElementById('dscfmt').value = 'ft';
    document.getElementById('dscver').value = '15122517';

    window.onbeforeunload = function ()
    {
      if (modified)
      {
        return "Discard changes and leave?";
      }
    };
	</script>
  <script src="./editor_util.js"></script>
  <script src="./menu.js"></script>
  <script src="./fmtlist.js"></script>
  <script type="module" src="./editor.js"></script>
  <script type="module" src="./dsc.js"></script>
</html>