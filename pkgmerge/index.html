<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PKG Merge</title>
    <meta name="theme-color" content="#b1eb34" />
</head>
<style>
    body {
    padding: 0;
    margin: 0;
    width: 100vw;
    height: 100vh;
    font-family: Arial, Helvetica, sans-serif;
    overflow: hidden;
    background: black;
    display: flex;
}

#droparea {
    margin: auto;
    border-radius: 3rem;
    filter: drop-shadow(0 0 0.75rem white);
    width: max-content;
    height: max-content;
    background: white;
    padding: 3rem;
    user-select: none;
    -webkit-user-select: none;
    text-align: center;
}
</style>
<body>
    <div id="droparea">
        Drag&Drop here:<br>
        PKG parts +<br>
        _sc.pkg (for PS5)
    </div>
</body>
<script>
const area = document.getElementById("droparea");
let mergingInProgress = false;

document.body.addEventListener("dragover", (e) => {
    e.stopPropagation();
    e.preventDefault();
});

document.body.addEventListener("drop", async (e) => {
    e.stopPropagation();
    e.preventDefault();
    
    const files = [...e.dataTransfer.files].filter(f => f.name.endsWith(".pkg"));
    if (files.length < 2) {
        area.innerText = "Please drop at least two .pkg files.";
        return;
    }

    try {
        mergingInProgress = true;
        window.addEventListener("beforeunload", warnBeforeUnload);
        await mergePkgFiles(files);
    } catch (err) {
        console.error(err);
        area.innerText = err.message || "An unknown error occurred during merge.";
    }
    finally {
        mergingInProgress = false;
        window.removeEventListener("beforeunload", warnBeforeUnload);
    }
});

async function mergePkgFiles(files) {
    const scFile = files.find(f => f.name.endsWith("_sc.pkg"));

    const nonScFiles = scFile ? files.filter(f => f !== scFile) : files;
    if (nonScFiles.length === 0) throw new Error("Missing non-_sc.pkg file(s).");

    const numberedParts = nonScFiles.filter(f => /_\d+\.pkg$/.test(f.name));
    const baseParts = nonScFiles.filter(f => !/_\d+\.pkg$/.test(f.name));

    let orderedFiles = [];

    if (numberedParts.length > 0) {
        orderedFiles = numberedParts.sort((a, b) => {
            const na = parseInt(a.name.match(/_(\d+)\.pkg$/)?.[1] ?? -1);
            const nb = parseInt(b.name.match(/_(\d+)\.pkg$/)?.[1] ?? -1);
            return na - nb;
        });
    } else if (baseParts.length === 1) {
        orderedFiles = baseParts;
    } else {
        throw new Error("Invalid .pkg file structure. Expected one base pkg or numbered sequence.");
    }

    if (scFile) orderedFiles.push(scFile);

    const outName = orderedFiles[0].name.replace(/(_\d+)?\.pkg$/, "_merged.pkg");

    if ('showSaveFilePicker' in window) {
        const handle = await window.showSaveFilePicker({
            suggestedName: outName,
            types: [{ description: "PKG files", accept: { "application/octet-stream": [".pkg"] } }],
        });
        const writable = await handle.createWritable();

        for (const file of orderedFiles) {
            area.innerText = `Please wait, merging ${file.name}...\n\nDo not close this window.`;
            const stream = file.stream();
            await stream.pipeTo(writable, { preventClose: true });
        }
        await writable.close();
        area.innerText = `Merged ${scFile ? "PS5" : "PS4"} package successfully into ${outName}.\n\nYou may now close this window.`;
    } else {
        const mergedBlob = await mergeFilesInMemory(orderedFiles);
        const a = document.createElement("a");
        a.href = URL.createObjectURL(mergedBlob);
        a.download = outName;
        a.click();
        area.innerText = `Merged ${scFile ? "PS5" : "PS4"} package successfully into ${outName}`;
    }
}

async function mergeFilesInMemory(files) {
    const parts = [];
    for (const file of files) {
        parts.push(await file.arrayBuffer());
    }
    return new Blob(parts, { type: "application/octet-stream" });
}

function warnBeforeUnload(e) {
    if (mergingInProgress) {
        e.preventDefault();
        e.returnValue = "Merging is in progress. Are you sure you want to leave?";
        return e.returnValue;
    }
}
</script>
</html>