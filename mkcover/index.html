<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <link href="../dsceditor/styles.css" rel="stylesheet">
    <link href="./styles.css" rel="stylesheet">
    <title>Cover Helper</title>
    <meta name="theme-color" content="#9a8cee" />
</head>

<body>
    <div>
        Want to add alternate versions of songs but don't know where to begin?<br>
        Don't worry, we've got you <i>covered!</i>
    </div>
    <br>
    <div class="row">
        <div id="step0" calss="metadata row">
            <!-- Metadata part 1 -->
            <div class="column">
                <label for="md_name">Mod name:</label><input autocomplete="on" type="text" id="md_name"
                    placeholder="My Cover Mod">
                <label for="md_description">Mod description:</label><input autocomplete="on" type="text"
                    id="md_description" placeholder="Adds covers.">
                <label for="md_version">Mod version:</label><input autocomplete="on" type="text" id="md_version"
                    placeholder="1.0">
                <label for="md_author">Mod author:</label><input autocomplete="on" type="text" id="md_author"
                    placeholder="MeTheModder, CoverMaker-P">
                <br>
                <div class="row footer">
                    <btn id="to_step0p2btn" class="modalbtn modalbtn_blue" onclick="step0to0p2();">Next</btn>
                </div>
            </div>
        </div>
        <div id="step0p2" class="metadata2 column" style="display: none;">
            <!-- Metadata part 2: result -->
            <br>
            <textarea autocomplete="off" id="newtoml"></textarea>
            <br>
            <btn id="tomldwbtn" class="modalbtn modalbtn_blue" onclick="toml_download_clicked();">Save</btn>
            <div class="filetree struct1" id="struct1">
                <div class="row file"><img src="./icons/folder-multi.png" alt="[]" width="32" height="32">Hatsune Miku
                    Project Diva Mega Mix+</div>
                <div class="row file indent1 indentarrow"><img src="./icons/folder-multi.png" alt="[]" width="32"
                        height="32">mods</div>
                <div class="row file indent1 indent2 indentarrow customfld"><img src="./icons/folder-multi.png" alt="[]"
                        width="32" height="32""><div id="modfld1">Template Mod</div>
            </div>
            <div class="row file indent1 indent2 indent3 indentarrow puthere customfld"><img src="./icons/text-x-generic.png"
                    alt="[]" width="32" height="32">config.toml</div>
            <div class="row file indent1 indentarrow"><img src="./icons/text-x-generic.png" alt="[]" width="32"
                    height="32">config.toml</div>
            <div class="row file indent1 indentarrow"><img src="./icons/application-x-sharedlib.png" alt="[]" width="32"
                    height="32">dinput8.dll</div>
            <div class="row file indent1 indentarrow"><img src="./icons/application-x-executable.png" alt="[]"
                    width="32" height="32">DivaMegaMix.exe</div>
            <div class="row file indent1 indentarrow"><img src="./icons/application-octet-stream.png" alt="[]"
                    width="32" height="32">...</div>
        </div>
        <div class="row footer">
            <btn id="to_step0btn" class="modalbtn modalbtn_red" onclick="to_step0();">Back</btn>
            <btn id="to_step1btn" class="modalbtn modalbtn_blue" onclick="to_step1();">Next</btn>
        </div>
    </div>
    <div id="step1" class="filter_area column" style="display: none;">
        <!-- Step 1: song -->
        <label for="filter">Filter:</label><input autocomplete="off" type="text" id="filter"
            oninput="filter(this.value);">
        <br>
        <select id="dropdown_db" size="10"></select>
        <div class="row footer">
            <btn id="to_step1btn" class="modalbtn modalbtn_red" onclick="to_step0p2();">Back</btn>
            <btn id="to_step2btn" class="modalbtn modalbtn_blue" onclick="to_step2();">Next</btn>
        </div>
    </div>
    <br>
    <div id="step2" class="another_song row" style="display: none;">
        <!-- Step 2: cover -->
        <div class="column">
            <label for="name_jp">Name (JP):</label><input autocomplete="on" type="text" id="name_jp"
                placeholder="MySong -Cover Edition-">
            <label for="voc_jp">Vocal (JP):</label><input autocomplete="on" type="text" id="voc_jp"
                placeholder="Cover Edition">
            <label for="name_en">Name (EN):</label><input autocomplete="on" type="text" id="name_en"
                placeholder="MySong -Cover Edition-">
            <label for="voc_en">Vocal (EN):</label><input autocomplete="on" type="text" id="voc_en"
                placeholder="Cover Edition">
            <label for="as_file">File name and extension:</label><input autocomplete="on" type="text" id="as_file"
                placeholder="pv_123_all.ogg">
            <br>
            <div class="row">
                <btn id="remlastbtn" class="modalbtn modalbtn_red" onclick="remlast_clicked();">Remove last</btn>
                <btn id="addasbtn" class="modalbtn modalbtn_blue" onclick="addas_clicked();">Add</btn>
            </div>
            <div class="row footer">
                <btn id="to_step2btn" class="modalbtn modalbtn_red" onclick="to_step1();">Back</btn>
                <btn id="to_step3btn" class="modalbtn modalbtn_blue" onclick="step2to3();">Next</btn>
            </div>
        </div>
        <div class="column">
            <table id="as_table">
                <tr>
                    <th>Name (JP)</th>
                    <th>Vocal (JP)</th>
                    <th>Name (EN)</th>
                    <th>Vocal (EN)</th>
                    <th>File</th>
                </tr>
            </table>
            <br>
        </div>
    </div>
    <div id="step3" class="entry_area column" style="display: none;">
        <!-- Step 3: result -->
        <textarea autocomplete="off" id="newentry"></textarea>
        <btn id="dwbtn" class="modalbtn modalbtn_blue" onclick="download_clicked();">Save</btn>
        <div class="filetree struct1" id="struct1">
            <div class="row file"><img src="./icons/folder-multi.png" alt="[]" width="32" height="32">Hatsune Miku
                Project Diva Mega Mix+</div>
            <div class="row file indent1 indentarrow"><img src="./icons/folder-multi.png" alt="[]" width="32"
                    height="32">mods</div>
            <div class="row file indent2 indentarrow customfld"><img src="./icons/folder-multi.png" alt="[]" width="32"
                    height="32">
                <div id="modfld2">Template Mod</div>
            </div>
            <div class="row file indent3 indentarrow customfld"><img src="./icons/folder-multi.png" alt="[]" width="32"
                    height="32">rom</div>
            <div class="row file indent4 indentarrow puthere customfld"><img src="./icons/text-x-generic.png" alt="[]" width="32"
                    height="32">mod_pv_db.txt</div>
            <div class="row file indent4 indentarrow customfld"><img src="./icons/folder-multi.png" alt="[]" width="32"
                    height="32">sound</div>
            <div class="row file indent5 indentarrow customfld"><img src="./icons/folder-multi.png" alt="[]" width="32"
                    height="32">song</div>
            <div class="row file indent6 indentarrow putsongshere customfld"><img src="./icons/audio-x-generic.png" alt="[]"
                    width="32" height="32">
                <div id="modaud1">pv_123_all.ogg</div>
            </div>
            <div class="row file indent6 indentarrow customfld"><img src="./icons/audio-x-generic.png" alt="[]" width="32"
                    height="32" id="modaud2">...</div>
            <div class="row file indent3 indentarrow customfld"><img src="./icons/text-x-generic.png" alt="[]" width="32"
                    height="32">config.toml</div>
            <div class="row file indent1 indentarrow"><img src="./icons/text-x-generic.png" alt="[]" width="32"
                    height="32">config.toml</div>
            <div class="row file indent1 indentarrow"><img src="./icons/application-x-sharedlib.png" alt="[]" width="32"
                    height="32">dinput8.dll</div>
            <div class="row file indent1 indentarrow"><img src="./icons/application-x-executable.png" alt="[]"
                    width="32" height="32">DivaMegaMix.exe</div>
            <div class="row file indent1 indentarrow"><img src="./icons/application-octet-stream.png" alt="[]"
                    width="32" height="32">...</div>
        </div>
        <div class="row footer">
            <btn id="to_step2btn" class="modalbtn modalbtn_red" onclick="to_step2();">Back</btn>
        </div>
    </div>
    </div>
</body>
<script src="./pv_db_list.min.js"></script>
<script>
    var getJSON = function (url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.responseType = 'text';
        xhr.onload = function () {
            var status = xhr.status;
            if (status === 200) {
                callback(null, xhr.response);
            } else {
                callback(status, xhr.response);
            }
        };
        xhr.send();
    };

    const entries = Object.entries(pv_db_list);
    for (const dben of entries) {
        const op = document.createElement('option');
        op.classList.add('songoption');
        op.value = dben[0];
        op.innerText = dben[0] + ': ' + dben[1].song_name_en;
        const select = document.getElementById('dropdown_db');
        select.appendChild(op);
    }

    function to_step0() {
        document.getElementById('step0p2').style.display = 'none';
        document.getElementById('step1').style.display = 'none';
        document.getElementById('step2').style.display = 'none';
        document.getElementById('step3').style.display = 'none';
        document.getElementById('step0').style.display = '';
    }

    function to_step0p2() {
        document.getElementById('step0').style.display = 'none';
        document.getElementById('step1').style.display = 'none';
        document.getElementById('step2').style.display = 'none';
        document.getElementById('step3').style.display = 'none';
        document.getElementById('step0p2').style.display = '';
    }

    function to_step1() {
        document.getElementById('step0').style.display = 'none';
        document.getElementById('step0p2').style.display = 'none';
        document.getElementById('step2').style.display = 'none';
        document.getElementById('step3').style.display = 'none';
        document.getElementById('step1').style.display = '';
    }

    function to_step2() {
        const selected = document.getElementById('dropdown_db').value;
        if (selected) {
            document.getElementById('step0').style.display = 'none';
            document.getElementById('step0p2').style.display = 'none';
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step3').style.display = 'none';
            document.getElementById('step2').style.display = '';
        }
        else {
            alert("No song selected.");
        }
    }

    function to_step3() {
        document.getElementById('step0').style.display = 'none';
        document.getElementById('step0p2').style.display = 'none';
        document.getElementById('step1').style.display = 'none';
        document.getElementById('step2').style.display = 'none';
        document.getElementById('step3').style.display = '';
    }

    function step0to0p2() {
        const name = document.getElementById('md_name').value;
        const description = document.getElementById('md_description').value;
        const version = document.getElementById('md_version').value;
        const author = document.getElementById('md_author').value;
        if (name == '' || description == '' || version == '' || author == '') {
            alert("Some fields are empty.")
        }
        else {
            const today = new Date();
            const date = String(today.getDate()).padStart(2, '0') + '.' + String(today.getMonth() + 1).padStart(2, '0') + '.' + String(today.getFullYear()).padStart(4, '0');
            const tomlarea = document.getElementById('newtoml');
            tomlarea.value = `enabled = true\ninclude = ["."]\n\nname = "${name}"\ndescription = "${description}"\nversion = "${version}"\ndate = "${date}"\nauthor = "${author}"`;
            document.getElementById('modfld1').innerText = name;
            document.getElementById('modfld2').innerText = name;
            to_step0p2();
        }
    }

    function step2to3() {
        const table = document.getElementById('as_table');
        if (table.rows.length > 1) {
            ok_clicked();
            const splitpath = table.rows[1].cells[4].innerText.split('/');
            document.getElementById('modaud1').innerText = splitpath[splitpath.length-1];
            to_step3();
        }
        else {
            alert("No entries to add.");
        }
    }

    function ok_clicked() {
        getJSON('./pv_db_entries_latest/' + document.getElementById('dropdown_db').value + '.json',
            function (err, data) {
                if (err !== null) {
                    alert('Something went wrong: ' + err);
                } else {
                    js2db(add_another_song(JSON.parse(data.replaceAll('.length=', '.lengthset='))));
                }
            });
    }

    function add_another_song(jsdb) {
        const table = document.getElementById('as_table');
        const amount = table.rows.length - 1;
        const jsen = jsdb[Object.entries(jsdb)[0][0]];
        jsen.date = new Date().toLocaleDateString('sv').replaceAll('-', '');
        if (amount > 0) {
            if (typeof jsen.another_song === 'undefined') {
                jsen.another_song = [];
                const chara = (typeof jsen.performer === 'undefined' || typeof jsen.performer[0] === 'undefined' || typeof jsen.performer[0].chara === 'undefined') ? "Original" : jsen.performer[0].chara;
                jsen.another_song.push({ "name": jsen.song_name, "name_en": jsen.song_name_en, "vocal_disp_name": chara, "vocal_disp_name_en": chara });
                jsen.another_song.lengthset = '1';
            }
            for (let i = 1; i < table.rows.length; i++) {
                const cells = table.rows[i].cells;
                try {
                    jsen.another_song.push({ "name": cells[0].innerText, "name_en": cells[2].innerText, "song_file_name": cells[4].innerText, "vocal_disp_name": cells[1].innerText, "vocal_disp_name_en": cells[3].innerText });
                    jsen.another_song.lengthset = parseInt(jsen.another_song.lengthset) + 1;
                }
                catch {
                    jsen.another_song[jsen.another_song.length] = { "name": cells[0].innerText, "name_en": cells[2].innerText, "song_file_name": cells[4].innerText, "vocal_disp_name": cells[1].innerText, "vocal_disp_name_en": cells[3].innerText };
                    jsen.another_song.length = parseInt(jsen.another_song.length) + 1;
                }
            }
        }
        return jsdb;
    }

    function filter(text) {
        const options = document.getElementsByClassName('songoption');
        Array.prototype.forEach.call(options, function (option) {
            if (text == '') {
                option.removeAttribute('hidden');
            }
            else {
                if (!option.innerText.toLowerCase().includes(text.toLowerCase())) {
                    option.setAttribute('hidden', 'true');
                }
                else {
                    option.removeAttribute('hidden');
                }
            }
        });
    }

    function js2db(oentry) {
        const dotted = dotNotate(oentry);
        const dottedentries = Object.entries(dotted);
        let allentries = [];
        Array.prototype.forEach.call(dottedentries, function (n) {
            allentries.push(n[0].replaceAll('._', '_') + '=' + n[1]);
        });
        document.getElementById('newentry').value = allentries.sort().join('\n').replaceAll('.lengthset=', '.length=');
    }

    function dotNotate(obj, target, prefix) {
        target = target || {},
            prefix = prefix || "";

        Object.keys(obj).forEach(function (key) {
            if (typeof (obj[key]) === "object" && obj[key] !== null) {
                dotNotate(obj[key], target, prefix + key + ".");
            } else {
                return target[prefix + key] = obj[key];
            }
        });

        return target;
    }

    function addas_clicked() {
        const table = document.getElementById('as_table');
        const namej = document.getElementById('name_jp');
        const vocj = document.getElementById('voc_jp');
        const namee = document.getElementById('name_en');
        const voce = document.getElementById('voc_en');
        const filen = document.getElementById('as_file');
        if (namej.value == '' || vocj.value == '' || namee.value == '' || voce.value == '') {
            alert("Some fields are empty.")
        }
        else if (filen.value === '') {
            alert("No file specified.");
        }
        else if (!filen.value.toLowerCase().endsWith('.ogg')) {
            alert("Unsupported file format.");
        }
        else if (filen.value.length < 5)
        {
            alert("Missing file name.")
        }
        else {
            const filep = 'rom/sound/song/' + filen.value;
            const row = table.insertRow(-1);
            row.insertCell(0).innerText = namej.value;
            row.insertCell(1).innerText = vocj.value;
            row.insertCell(2).innerText = namee.value;
            row.insertCell(3).innerText = voce.value;
            row.insertCell(4).innerText = filep;
        }
    }

    function clearas_clicked() {
        const table = document.getElementById('as_table');
        while (table.rows.length > 1) { table.deleteRow(1); }
    }

    function remlast_clicked() {
        const table = document.getElementById('as_table');
        if (table.rows.length > 1) {
            table.deleteRow(-1);
        }
    }

    function download(text, filename, filetype) {
        const fileblob = new Blob([text], { type: filetype });
        const filelink = document.createElement('a');
        const fileurl = URL.createObjectURL(fileblob);
        filelink.href = fileurl;
        filelink.target = "_blank";
        filelink.download = filename;
        filelink.click();
        filelink.remove();
    }

    function download_clicked() {
        download(document.getElementById('newentry').value, "mod_pv_db.txt", 'text/plain');
    }

    function toml_download_clicked() {
        download(document.getElementById('newtoml').value, "config.toml", 'application/toml');
    }
</script>

</html>